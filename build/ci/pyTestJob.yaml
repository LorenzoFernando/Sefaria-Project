---
apiVersion: batch/v1
kind: Job
metadata:
  name: jobjob
spec:
  template:
      containers:
        - name: web
          image: "{{ .Values.web.containerImage }}:{{ .Values.releaseImageTag }}"
          imagePullPolicy: Always
          env:
            # WEB_CONCURRENCY is used for determining the number of server workers
            - name: GOOGLE_APPLICATION_CREDENTIALS
              value: /app/logging-secret.json
            - name: ENV_NAME
              value: "{{ .Values.deployEnv }}"
            - name: STACK_COMPONENT
              value: web
          ports:
            - containerPort: 80
              protocol: TCP
          resources:
            request:
              memory: "9Gi"
              cpu: "1500m"
            limit:
              memory: "10Gi"
              cpu: "2000m"

          volumeMounts:
            # https://stackoverflow.com/questions/53491603/kubernetes-volumemounts-a-file-not-a-directory
            - mountPath: /app/sefaria/local_settings.py
              name: local-settings
              subPath: local_settings.py
              readOnly: true
            - mountPath: /varnish-secret
              name: varnish-secret
              readOnly: true
            - mountPath: /school-lookup-data
              name: school-lookup-data
              readOnly: true
            - mountPath: /client-secret
              name: client-secret
              readOnly: true
            - mountPath: /google-cloud-secret
              name: backup-manager-secret
              readOnly: true
            - mountPath: /app/logging-secret.json
              name: logging-secret
              subPath: logging-secret.json
              readOnly: true
            - mountPath: /log
              name: logdir
        - name: django-log
          image: busybox
          args: [/bin/sh, -c, 'touch /log/django_request.log && chmod 777 /log/django_request.log && tail -n+1 -f /log/django_request.log | grep -v "WARNING django.request" > /dev/stderr']
          volumeMounts:
            - name: logdir
              mountPath: /log
          resources:
            request:
              memory: "512Mi"
              cpu: "200m"
            limit:
              memory: "796Mi"
              cpu: "400m"   
        - name: gunicorn-log
          image: busybox
          args: [/bin/sh, -c, 'touch /log/gunicorn-error.log && chmod 777 /log/gunicorn-error.log && tail -n+1 -f /log/gunicorn-error.log | grep -v "WARNING django.request" > /dev/stderr']
          volumeMounts:
            - name: logdir
              mountPath: /log
          resources:
            request:
              memory: "512Mi"
              cpu: "200m"
            limit:
              memory: "796Mi"
              cpu: "400m"    
        
      volumes:
        - name:  local-settings
          secret:
            secretName: local-settings-{{ .Values.deployEnv }}
        - name: client-secret
          secret:
            secretName: google-client-secret-{{ .Values.deployEnv }}
        - name: backup-manager-secret  # used to access google cloud
          secret:
            secretName: backup-manager-secret-{{ .Values.deployEnv }}
        - name: logging-secret
          secret:
            secretName: logging-secret-{{ .Values.deployEnv }}
        - name: varnish-secret
          secret:
            secretName: varnish-secret-{{ .Values.deployEnv }}
        - name:  school-lookup-data
          secret:
            secretName: school-lookup-data-{{ .Values.deployEnv }}
        - name: logdir
          emptyDir: {}    

...
